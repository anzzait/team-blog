name: Gatsby Build on Specific Issue Comment

on:
  issue_comment:
    types: [created]

env:
  TARGET_ISSUE_TITLE: "Contentful-Deployed-History" # Issue 名の定数

jobs:
  check-comment:
    runs-on: ubuntu-latest
    if: github.event.issue.title == env.TARGET_ISSUE_TITLE
    outputs:
      is_relevant_comment: ${{ steps.filter-comment.outputs.is_relevant_comment }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Filter by Comment
        id: filter-comment
        run: |
          COMMENT_BODY=$(jq -r ".comment.body" $GITHUB_EVENT_PATH)
          echo "Comment body is '$COMMENT_BODY'"
          echo "::set-output name=is_relevant_comment::true" # すべてのコメントをトリガーとして使用

  build-and-deploy:
    needs: check-comment
    if: needs.check-comment.outputs.is_relevant_comment == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.3.1' # または好みの Node.js のバージョン

      - name: Install Dependencies
        run: npm install

      - name: Build Gatsby Site
        run: npm run build
        env:
          CONTENTFUL_ACCESS_TOKEN: ${{ secrets.CONTENTFUL_ACCESS_TOKEN }}
          CONTENTFUL_SPACE_ID: ${{ secrets.CONTENTFUL_SPACE_ID }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public # Gatsby ビルドの出力ディレクトリ
